# d6a99e14e3b173899b76dc3c9a8f0f70b604342fc78e5ff30a07650fc1bdbcc4
# Dockerfile generated by Maru 0.1.0

# Staged build using builder container
FROM janeliascicomp/builder:1.2.1 as builder
ARG GIT_TAG=master

# Checkout and build the code
WORKDIR /tmp/app
RUN git clone --branch $GIT_TAG --depth 1 https://github.com/JaneliaSciComp/jacs-tools-docker.git . \
    && /usr/local/bin/buildinfo.sh \
    && true

# Create final image
FROM condaforge/miniforge3:24.3.0-0

RUN conda create -n myenv python=3.6 h5py=2.8.0 -y \
    && conda clean --tarballs \
    && mkdir -p /opt/conda/envs/myenv/etc/conda/activate.d \
    # It's necessary to set TMPDIR for running with Singularity, because /opt/conda will be read-only
    && echo "export TMPDIR=/tmp" > /opt/conda/envs/myenv/etc/conda/activate.d/env_vars.sh

COPY --from=builder /tmp/app /app
COPY --from=builder /buildinfo /

RUN echo "#!/bin/bash" >> /entrypoint.sh \
    && echo "source /opt/conda/etc/profile.d/conda.sh" >> /entrypoint.sh \
    && echo "conda activate myenv" >> /entrypoint.sh \
    && echo 'python /app/h5j_extract_channels/src/extract_channels.py "$@"' >> /entrypoint.sh \
    && chmod +x /entrypoint.sh
ENTRYPOINT [ "/entrypoint.sh" ]
